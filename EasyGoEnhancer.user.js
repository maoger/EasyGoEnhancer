// ==UserScript==
// @name         EasyGoEnhancer
// @icon         http://www.ascendacpa.com.cn/favicon.ico
// @homepage     https://github.com/maoger/EasyGoEnhancer
// @version      3.9.9
// @description  Make EasyGo easier to go.
// @author       Maoger
// @match        http*://*.ascendacpa.com.cn/*
// @match        http*://10.131.0.7/*
// @require      https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js
// @resource     https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css
// @updateURL    https://openuserjs.org/meta/maoger/EasyGoEnhancer.meta.js
// @copyright    2016-2021, maoger (https://openuserjs.org/users/maoger)
// @license      MIT

// ==/UserScript==

function EasyGoEnhancer_main(){"use strict";$("title").html("EasyGo | maoyanqing.com"),$(".NewTitle1").length>0?(load_working_hours(),load_toDoList()):window.location.href.indexOf("/Confirmation.aspx")>=0?(letter_download_multi(),letter_save_url()):window.location.href.indexOf("/ConfirmationEdit.aspx")>=0?letter_download_single_auto():window.location.href.indexOf("/ConfirmationEdit2014.aspx?ID=")>=0?XZHCX_download():window.location.href.indexOf("/RiskManagement/")>=0?($("title").html("EasyGo"),fix_printer()):console.log("欢迎使用 EasyGoEnhancer !")}function load_toDoList(){"use strict";var t=["业务项目","业务报告","人文财务","独立性","综合"],e=$(".NewTitle1"),a=$("<div/>");if(0!==e.length){e.children().not(":first").remove(),a.insertAfter(e);var n=$("<div/>").addClass("barSpace").css({margin:"0.25px 0px",background:"grey","border-radius":"1px"});n.insertAfter(e);var o=$("<span/>").attr("id","barsmooth").addClass("smooth").css({height:"0.25px",width:"0%","border-radius":"1px",display:"block","box-shadow":"0px 0px 10px 1px #CC66FF","background-color":"#fff"});n.append(o);var r=$("<a/>").attr("href","/Module/Framework/Acpa/Project/UserScheduleDynamic.aspx").css({"margin-right":"30px",color:"#333"}).html("<i class='far fa-check-circle'></i>&nbsp;动态报备");e.append(r);var l=$("<a/>").attr("href","/Module/Framework/Acpa/Manhour/report.aspx").css({"margin-right":"30px",color:"#333"}).html("<i class='far fa-clock'></i>&nbsp;申报工时");e.append(l);var i=$("<a/>").attr("href","/Module/Framework/Acpa/ClientInfo/ProFieldNav.aspx").css({"margin-right":"30px",color:"#333"}).html("<i class='fas fa-sitemap'></i>&nbsp;函证中心");e.append(i);var s=$("<a/>").attr("href","/Module/Framework/Acpa/Project/ConfirmationList2014.aspx").attr("target","_blank").css({"margin-right":"30px",color:"#333"}).html("<i class='fas fa-search'></i>&nbsp;询证函查询");if(e.append(s),window.localStorage&&localStorage.letter_href){var c=$("<a/>").attr("href",localStorage.letter_href).attr("target","_blank").css({"margin-right":"30px",color:"#333"}).html("<i class='far fa-eye'></i>&nbsp;最近查看的询证函");e.append(c)}for(var d=0,p=0;p<t.length;p++){var f=t[p],h=$("<table/>").attr("data-name",f).addClass("tablebox").css({"text-align":"left"}).html("<span>正在加载<b>"+f+"</b>中，请稍候...</span>");a.append(h);var m="/MoreTask3.aspx?ind="+(p+1).toString()+" #tabContent__"+p.toString()+" div:first tr:gt(0)";h.load(m,function(t,e,a){if("success"===e)var r=self.setInterval(function(){d<20*(p-1)?(d=20*(p-1),o.css("width",d.toString()+"%")):d<20*p?(d+=.1,o.css("width",d.toString()+"%")):console.log("欢迎使用EasyGoEnhancer !"),d>=100&&(clearInterval(r),setTimeout(function(){n.css("margin","0px"),o.css({width:"0%",height:"0px"})},600))},10);"error"===e&&$(this).html('<span style="color: red;">加载<b>'+$(this).attr("data-name")+"</b>失败！</span>")})}}}function load_working_hours(){"use strict";var t=$(".NewTitle1"),e=$("<span/>").html("本月已工作："),a=$("<td/>").html("&nbsp;个小时，"),n=$("<td/>").html("本月已出差："),o=$("<td/>").html("&nbsp;天。"),r=$("<a/>").attr("href","/Module/Framework/Acpa/Manhour/report.aspx").css({"font-weight":"bold",color:"red"}),l=$("<a/>").attr("href","/Module/Framework/Acpa/Manhour/report.aspx").css({"font-weight":"bold",color:"red"});e.insertBefore(t),e.append(r),a.insertAfter(r),n.insertAfter(a),l.insertAfter(n),o.insertAfter(l);r.load("/Module/Framework/Acpa/Manhour/report.aspx #tabContent__0 div:eq(1) tr:last td:eq(1)");l.load("/Module/Framework/Acpa/Manhour/report.aspx #tabContent__0 div:eq(1) tr:last td:eq(2)")}function getBlob(t){return new Promise(e=>{const a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="blob",a.onload=(()=>{200===a.status&&e(a.response)}),a.send()})}function saveAs(t,e){if(window.navigator.msSaveOrOpenBlob)navigator.msSaveBlob(t,e);else{const a=document.createElement("a"),n=document.querySelector("body");a.href=window.URL.createObjectURL(t),a.download=e,a.style.display="none",n.appendChild(a),a.click(),n.removeChild(a),window.URL.revokeObjectURL(a.href)}}function download(t,e){getBlob(t).then(t=>{saveAs(t,e)})}function letter_download_multi(){"use strict";$(".menubar_title")[0].innerHTML="<a href='//maoyanqing.com/download/easygoenhancer.html' target='_blank' style='font-family:Calibri; font-size: 26px; color: #009CDE'>EasyGoEnhancer</a>";var t=$("#ctl00_PageBody_AspNetPager1");$("<td/>").html("<br/><hr/><b>Notes:</b><br/><span style='font-family:Calibri; font-size: 12px; color: #9E9E9E'><b>1、筛选</b><br/>点击上述【查询】按钮，查看更多选项；<br/>比如：可以按照 “回函扫描创建日期” 、 “回函收件人” 等，先筛选回函结果，再下载...<br/><br/><b>2、建议</b><br/>将浏览器设置为静默下载（不弹出下载框），详见：<a target='_blank' href='//maoyanqing.com/download/easygoenhancer-docs.html' style='font-family: Calibri; font-size: 12px; color: #0000cc;'>开启静默下载的操作提示</a></span>").insertAfter(t);var e=$("#ctl00_PageBody_lblFullName"),a={},n="",o=localStorage.letter_download_mark,r=0;if((r=void 0==o?0:Math.ceil(o/10))>0){a=void 0==(n=localStorage.letter_download)||""==n?{}:JSON.parse(n);for(var l=localStorage.letter_download_mark,i="",s=document.getElementsByTagName("a"),c=0;c<s.length;c++)(i=s[c].href).indexOf("?ID=")>=0&&(a[l--]=i);n=JSON.stringify(a),localStorage.letter_download=n,o=Math.max(0,o-10),r=Math.ceil(o/10),localStorage.letter_download_mark=o,r>0&&__doPostBack("ctl00$PageBody$AspNetPager1",r)}if(0==o){a=void 0==(n=localStorage.letter_download)||""==n?{}:JSON.parse(n);for(var d in e.append("<span style='font-family:Calibri; font-size: 14px; color: #3F9C35'>&nbsp;<i class='fas fa-spinner fa-pulse'></i>&nbsp;EasyGoEnhancer 正在为您自动下载询证函... 请耐心等待所有询证函下载完毕后再关闭本网页...</span>"),a)create_iframe(d,a[d],0,0);localStorage.removeItem("letter_download"),localStorage.removeItem("letter_download_mark")}var p=$("#ctl00_PageBody_AspNetPager1 > table > tbody > tr > td:nth-child(1)").text().split("：")[1].split(" ")[0];if(p>0&&void 0==o){var f=$("<button/>").attr("type","button").html("<span style='font-family:Calibri; font-size: 16px; font-weight: bold; color: #009CDE'><i class='fas fa-cloud-download-alt'></i>&nbsp;点击下载</span>");f.insertAfter(e),f.click(function(){this.style.display="none",localStorage.letter_download_mark=p,(r=Math.ceil(p/10))>1?__doPostBack("ctl00$PageBody$AspNetPager1",r):location.reload()})}}function create_iframe(t,e,a,n){var o=document.createElement("iframe");o.id=t,o.width=a,o.height=n,o.src=e,document.body.appendChild(o)}function letter_download_single_auto(){"use strict";for(var t="",e=$("#ctl00_PageBody_lblConfID").text(),a=$("#ctl00_PageBody_txtConfirmationName").val(),n=$("#ctl00_PageBody_lblConfID"),o=$("<span/>").html("<span style='font-style:italic; font-family:Calibri; font-size: 14px; color: #3F9C35'>&nbsp;&nbsp;<i class='fas fa-spinner fa-pulse'></i>&nbsp;EasyGoEnhancer 正在为您自动下载询证函... 请耐心等待所有询证函下载完毕后再关闭本网页...</span>"),r=$("<span/>").html("<span style='font-style:italic; font-family:Calibri; font-size: 14px; color: #EEA9B8'>&nbsp;&nbsp;暂未回函！如果已发函很长时间了，请尽快催函，或加强催函力度……</span>"),l="",i="",s=document.getElementsByTagName("a"),c=[],d="",p=["pdf","PDF","jpg","JPG"],f=0;f<s.length;f++)if(d=(c=(i=s[f].href).split("."))[c.length-1],p.includes(d)){l=i;break}if(""==l)r.insertAfter(n);else{t="checked"==document.getElementById("ctl00_PageBody_rblIsMatch_0").getAttribute("checked")?"Y":"checked"==document.getElementById("ctl00_PageBody_rblIsMatch_1").getAttribute("checked")?"N":"?",o.insertAfter(n);var h=0;for(f=0;f<s.length;f++)d=(c=(i=s[f].href).split("."))[c.length-1],p.includes(d)&&download(l=i,1==(h+=1)?"["+t+"]_"+e+"_"+a+"."+d:"["+t+"]_"+e+"_"+a+"_"+h.toString()+"."+d)}}function XZHCX_download(){"use strict";$(".menubar_title")[0].innerHTML="<a href='//maoyanqing.com/download/easygoenhancer.html' target='_blank' style='font-family:Calibri; font-size: 26px; color: #009CDE'>EasyGoEnhancer</a>";var t=$("#FrameWork_Acpa_EasyGoSelectIndex"),e=$("<button/>").attr("type","button").html("<span style='font-family:Calibri; font-size: 16px; font-weight: bold; color: #009CDE'><i class='fas fa-cloud-download-alt'></i>&nbsp;点击下载</span>");e.insertAfter(t);var a=$("<span/>").html("<span style='font-family:Calibri; font-size: 14px; color: #009CDE'>&nbsp;&nbsp;以下列示的所有询证函中&nbsp;&nbsp;</span><span style='font-family:Calibri; font-size: 14px; color: #EEA9B8'>上传日期</span>&nbsp;<kbd>≥</kbd>&nbsp;");a.insertAfter(e);var n=$("<input/>").attr("id","input_date").attr("type","date").attr("value","");n.insertAfter(a),$("<p/>").html("<br/><hr/><span style='font-family:Calibri; font-size: 12px; color: #9E9E9E'><b>【建议】</b>将浏览器设置为静默下载（不弹出下载框），详见：<a target='_blank' href='//maoyanqing.com/download/easygoenhancer-docs.html' style='font-family: Calibri; font-size: 12px; color: #0000cc;'>开启静默下载的操作提示</a></span>").insertAfter(n);var o=new Date,r=o.getFullYear(),l=o.getMonth()+1;l=l<10?"0"+l:l;var i=o.getDate(),s=r+"-"+l+"-"+(i=i<10?"0"+i:i);n.val(s),e.click(function(){if(this.style.display="none",$("<span/>").html("<span style='font-style:italic; font-family:Calibri; font-size: 14px; color: #3F9C35'>&nbsp;&nbsp;<i class='fas fa-spinner fa-pulse'></i>&nbsp;EasyGoEnhancer 正在为您自动下载&nbsp;&nbsp;</span>").insertAfter(t),$("<span/>").html("<span style='font-style:italic; font-family:Calibri; font-size: 14px; color: #3F9C35'>&nbsp;&nbsp;的询证函... 请耐心等待所有询证函下载完毕后再关闭本网页...</span>").insertAfter(n),""==(s=n.val())||void 0==s){var e=new Date,a=e.getFullYear(),o=e.getMonth()+1;o=o<10?"0"+o:o;var r=e.getDate();s=a+"-"+o+"-"+(r=r<10?"0"+r:r)}XZHCX_download_main(s)})}function XZHCX_download_main(t){"use strict";for(var e="",a="",n=(new Date,new Date,document.getElementsByTagName("a")),o=[],r="",l=["pdf","PDF","jpg","JPG"],i=0;i<n.length;i++)r=(o=(e=n[i].href).split("."))[o.length-1],l.includes(r)&&(a=n[i].parentNode.nextSibling.nextSibling.innerHTML,new Date(a)>=new Date(t)&&download(e,n[i].innerHTML))}function fix_printer(){"use strict";for(var t,e=$(".button_bak").length,a=0;a<e;a++)(t=$("#Button"+(a+1))).val().indexOf("打印")>=0&&(t.removeAttr("onclick"),t.attr("onclick","window.print();"))}function letter_save_url(){"use strict";if(window.localStorage){var t=window.location;localStorage.letter_href=t.href.replace(t.origin,"")}}EasyGoEnhancer_main();